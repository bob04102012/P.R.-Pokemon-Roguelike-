<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poké-Roguelike World</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        :root{--main-font:'Press Start 2P',cursive;--border-color:#333;--background-color:#f0f0f0;--player1-color:#4a90e2;--player2-color:#e24a4a;--grass-type:#78C850;--fire-type:#F08030;--water-type:#6890F0;--electric-type:#F8D030;--rock-type:#B8A038;--ghost-type:#705898;--normal-type:#A8A878; --shrine-color: #d4af37; --mart-color: #4a90e2; --center-color: #e24a4a;}
        body{font-family:var(--main-font);background-color:var(--background-color);color:#333;text-align:center;padding:10px;font-size:12px;overflow:hidden;}
        .hidden{display:none!important}#battle-ui, #hub-ui { width: 100%; max-width: 900px; margin: auto; }
        /* Battle CSS (Same as before) */
        .arena{display:flex;justify-content:space-around;gap:20px;margin-bottom:15px}.player-area{width:48%}.party-display{display:flex;gap:5px;margin-bottom:10px;justify-content:center;height:40px}
        .party-mon{border:2px solid #ccc;padding:5px;font-size:10px;opacity:0.6;cursor:pointer;position:relative}
        .party-mon img { width: 32px; height: 32px; image-rendering: pixelated; display: block; margin: 0 auto 4px auto; }
        .party-mon.active{border-color:gold;opacity:1;transform:scale(1.1)}.party-mon.fainted{background-color:#555;color:#999;text-decoration:line-through}
        .main-card{border:4px solid var(--border-color);padding:15px;background:white}.main-card img {width:96px; height:96px; image-rendering:pixelated; margin: 10px auto; display: block; border: 2px solid #333; background: #eee;}
        .pokemon-name{font-size:16px;margin-bottom:10px;min-height:20px;}.health-bar-container{width:100%;height:18px;background-color:#e0e0e0;border:2px solid var(--border-color);margin-bottom:5px}.health-bar{height:100%;background-color:#4CAF50;width:100%;transition:width .5s ease-in-out}.hp-text{font-size:10px;text-align:right;margin-bottom:10px}
        .moves-container button { width: calc(50% - 4px); padding: 8px; margin: 2px; font-family: var(--main-font); font-size: 10px; cursor: pointer; border: 2px solid var(--border-color); }
        #message-log{padding:15px;background:white;border:4px solid var(--border-color);min-height:60px;text-align:left;line-height:1.5;margin-top:10px}
        /* Hub / Map CSS */
        #hub-container { position: relative; width: 800px; height: 600px; margin: auto; border: 4px solid #333; }
        #map-canvas { background-color: #5a8d3c; image-rendering: pixelated; width: 100%; height: 100%; }
        .hub-overlay { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: white; padding: 10px; font-size: 14px; display: flex; justify-content: space-between; width: calc(100% - 40px); }
        .hub-overlay button { font-family: var(--main-font); font-size: 12px; margin-left: 20px; }
        #hub-party-display { position: absolute; bottom: 10px; left: 10px; display: flex; gap: 5px; background: rgba(0,0,0,0.6); padding: 5px; border-radius: 5px; }
        /* Modal CSS */
        #modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:99;display:flex;justify-content:center;align-items:center}.modal-content{background:white;padding:30px;border:4px solid var(--border-color);max-width:80%;width:700px;max-height:80vh;overflow-y:auto;}
        #modal-title{font-size:20px;margin-bottom:20px}#choices-container{display:flex;flex-direction:column;gap:15px;}
        .choice-card{border:3px solid var(--border-color);padding:15px;cursor:pointer;transition:all .2s ease;display:flex;justify-content:space-between;align-items:center;}.choice-card:hover{background-color:#eee}
        .choice-card.purchased { background-color: #d3d3d3; color: #888; cursor: not-allowed; }
        .upgrade-info p { margin: 0; font-size: 10px; line-height: 1.4; }
    </style>
</head>
<body>
    <div id="battle-ui" class="hidden">
        <!-- Battle UI HTML is identical to previous version -->
    </div>
    
    <div id="hub-ui">
        <div id="hub-container">
            <canvas id="map-canvas" width="800" height="600"></canvas>
            <div class="hub-overlay">
                <div id="currency-display">$P 0</div>
                <div>
                    <button id="challenge-btn">Find Battle</button>
                    <button id="shop-btn">Poké Mart</button>
                </div>
            </div>
            <div id="hub-party-display"></div>
        </div>
        <div id="message-log">Welcome to the Hub World! Find the Shrine to battle!</div>
    </div>

    <div id="modal-overlay" class="hidden">
        <div class="modal-content">
            <h2 id="modal-title"></h2>
            <div id="choices-container"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const socket = io();

            const battleUI = document.getElementById('battle-ui');
            const hubUI = document.getElementById('hub-ui');
            const mapCanvas = document.getElementById('map-canvas');
            const mapCtx = mapCanvas.getContext('2d');
            const messageLog = document.getElementById('message-log');
            const modalOverlay = document.getElementById('modal-overlay');
            const modalTitle = document.getElementById('modal-title');
            const choicesContainer = document.getElementById('choices-container');
            const currencyDisplay = document.getElementById('currency-display');
            const hubPartyDisplay = document.getElementById('hub-party-display');
            const challengeBtn = document.getElementById('challenge-btn');
            const shopBtn = document.getElementById('shop-btn');
            const TILE_SIZE = 40;

            let selfId = null, gameState = null, uiState = 'hub', mapData = { location: null, grid: null }, playerState = null;

            // ... Image Generation code is identical ...
            function generatePokemonImage(name) { /* ... */ }

            function switchUI(state) {
                uiState = state;
                [battleUI, hubUI].forEach(el => el.classList.add('hidden'));
                if (state.includes('Battle')) battleUI.classList.remove('hidden');
                if (state === 'hub') hubUI.classList.remove('hidden');
            }

            const TILE_COLORS = { 0: '#7bb764', 1: '#4a3d2a', 2: '#5b98de', 3: '#4e8538', 4: 'var(--shrine-color)', 5: 'var(--mart-color)', 6: 'var(--center-color)' };
            function drawMap() { /* ... identical map drawing code ... */ }
            
            function renderHubUI() {
                if (!playerState) return;
                currencyDisplay.textContent = `$P ${playerState.currency}`;
                hubPartyDisplay.innerHTML = '';
                playerState.party.forEach(mon => {
                    const monDiv = document.createElement('div');
                    monDiv.className = 'party-mon';
                    monDiv.innerHTML = `<img src="${generatePokemonImage(mon.name)}" title="${mon.name} - HP: ${Math.ceil(mon.currentHp)}/${mon.maxHp}"/>`;
                    if(mon.isFainted) monDiv.classList.add('fainted');
                    hubPartyDisplay.appendChild(monDiv);
                });
            }
            
            function showShopModal() {
                modalOverlay.classList.remove('hidden');
                modalTitle.textContent = "Poké Mart - Permanent Upgrades";
                choicesContainer.innerHTML = '';
                // In a real game, this would come from the server
                const PERMANENT_UPGRADES = {
                    'hp_plus_1': { name: "Vitality Training", cost: 100, description: "All your Pokémon start with +10 max HP permanently."},
                    'atk_plus_1': { name: "Attack Training", cost: 150, description: "All your Pokémon start with +5 base Attack permanently."},
                    'better_mons': { name: "Scouting Report", cost: 300, description: "Your starting Pokémon will have slightly better base stats."}
                };

                for (const id in PERMANENT_UPGRADES) {
                    const upgrade = PERMANENT_UPGRADES[id];
                    const card = document.createElement('div');
                    card.className = 'choice-card';
                    card.innerHTML = `<div class="upgrade-info"><h3>${upgrade.name}</h3><p>${upgrade.description}</p></div><div class="upgrade-cost">$P ${upgrade.cost}</div>`;
                    
                    if (playerState.upgrades.purchased.includes(id)) {
                        card.classList.add('purchased');
                        card.onclick = null;
                    } else if (playerState.currency < upgrade.cost) {
                        card.classList.add('purchased'); // Re-use style for unaffordable
                        card.onclick = null;
                    } else {
                        card.onclick = () => { socket.emit('buyUpgrade', id); modalOverlay.classList.add('hidden'); };
                    }
                    choicesContainer.appendChild(card);
                }
                modalOverlay.onclick = (e) => { if(e.target === modalOverlay) modalOverlay.classList.add('hidden'); };
            }

            // --- Socket Listeners ---
            socket.on('connect', () => { selfId = socket.id; });
            socket.on('enterHubMode', (data) => {
                playerState = data.playerState;
                mapData = { location: data.location, grid: data.mapGrid };
                switchUI('hub');
                renderHubUI();
                drawMap();
            });
            socket.on('updatePlayerState', (newPlayerState) => {
                playerState = newPlayerState;
                renderHubUI();
            });
            // ... Other listeners for gameStart, updateGameState, logMessage, promptChoice, map movement, etc. ...
            
            // --- Input Listeners ---
            challengeBtn.addEventListener('click', () => {
                socket.emit('enterChallengeQueue');
                challengeBtn.disabled = true;
                challengeBtn.textContent = 'Waiting...';
            });
            shopBtn.addEventListener('click', showShopModal);
            
            window.addEventListener('keydown', (e) => {
                if (uiState !== 'hub') return;
                const key = e.key.toLowerCase();
                const tile = mapData.grid[mapData.location.y][mapData.location.x];
                if (key === 'e' || key === 'enter') { // Interact key
                    if (tile === 5) showShopModal();
                    if (tile === 6) socket.emit('healParty');
                    if (tile === 4) challengeBtn.click();
                }
                if (['w', 'a', 's', 'd'].includes(key)) { socket.emit('move', { direction: key }); }
            });
        });
    </script>
</body>
</html>

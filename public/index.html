<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poké-Roguelike World</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        :root{--main-font:'Press Start 2P',cursive;--border-color:#333;--background-color:#f0f0f0;--player1-color:#4a90e2;--player2-color:#e24a4a;--grass-type:#78C850;--fire-type:#F08030;--water-type:#6890F0;--electric-type:#F8D030;--rock-type:#B8A038;--ghost-type:#705898;--normal-type:#A8A878}body{font-family:var(--main-font);background-color:var(--background-color);color:#333;text-align:center;padding:10px;font-size:12px;overflow:hidden;}
        .hidden{display:none!important}#lobby, #battle-ui, #map-ui { width: 100%; max-width: 900px; margin: auto; }
        .start-button{font-family:var(--main-font);font-size:16px;padding:15px 30px;cursor:pointer;background:#4CAF50;color:white;border:2px solid var(--border-color);box-shadow:4px 4px 0 var(--border-color);transition:all .1s ease}.start-button:active{transform:translate(4px,4px);box-shadow:none}
        .arena{display:flex;justify-content:space-around;gap:20px;margin-bottom:15px}.player-area{width:48%}.party-display{display:flex;gap:5px;margin-bottom:10px;justify-content:center;height:40px}
        .party-mon{border:2px solid #ccc;padding:5px;font-size:10px;opacity:0.6;cursor:pointer;position:relative}
        .party-mon img { width: 32px; height: 32px; image-rendering: pixelated; display: block; margin: 0 auto 4px auto; }
        .party-mon.active{border-color:gold;opacity:1;transform:scale(1.1)}.party-mon.fainted{background-color:#555;color:#999;text-decoration:line-through}
        .main-card{border:4px solid var(--border-color);padding:15px;background:white}.main-card img {width:96px; height:96px; image-rendering:pixelated; margin: 10px auto; display: block; border: 2px solid #333; background: #eee;}
        #self-main-card{border-color:var(--player1-color)}#opponent-main-card{border-color:var(--player2-color)}
        .pokemon-name{font-size:16px;margin-bottom:10px;min-height:20px;}.health-bar-container{width:100%;height:18px;background-color:#e0e0e0;border:2px solid var(--border-color);margin-bottom:5px}.health-bar{height:100%;background-color:#4CAF50;width:100%;transition:width .5s ease-in-out}.hp-text{font-size:10px;text-align:right;margin-bottom:10px}
        .moves-container button { width: calc(50% - 4px); padding: 8px; margin: 2px; font-family: var(--main-font); font-size: 10px; cursor: pointer; border: 2px solid var(--border-color); }
        #message-log{padding:15px;background:white;border:4px solid var(--border-color);min-height:60px;text-align:left;line-height:1.5;margin-top:10px}
        #modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:99;display:flex;justify-content:center;align-items:center}.modal-content{background:white;padding:30px;border:4px solid var(--border-color);max-width:80%;width:700px}
        #modal-title{font-size:20px;margin-bottom:20px}#choices-container{display:flex;justify-content:space-around;gap:15px;flex-wrap:wrap;}
        .choice-card{border:3px solid var(--border-color);padding:15px;flex-grow:1;cursor:pointer;transition:all .2s ease;text-align:center;width:180px}.choice-card:hover{transform:translateY(-5px);box-shadow:0 5px 10px rgba(0,0,0,.2);border-color:gold}
        .choice-card h3{margin:0 0 10px 0;font-size:14px}.choice-card p{font-size:10px;line-height:1.4;margin:0}
        #map-container { position: relative; width: 800px; height: 600px; margin: auto; border: 4px solid #333; }
        #map-canvas { background-color: #5a8d3c; image-rendering: pixelated; width: 100%; height: 100%; }
        #map-overlay-text { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: white; padding: 10px; font-size: 14px; }
        #map-party-display { position: absolute; bottom: 10px; left: 10px; display: flex; gap: 5px; background: rgba(0,0,0,0.6); padding: 5px; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="lobby">
        <h1>Poké-Roguelike World</h1>
        <p id="lobby-text">Find an opponent to begin your journey!</p>
        <button id="find-game-btn" class="start-button">Find Game</button>
    </div>

    <div id="battle-ui" class="hidden">
        <div class="arena">
            <div id="self-area" class="player-area">
                <div id="self-party-display" class="party-display"></div>
                <div id="self-main-card" class="main-card">
                    <div id="self-pokemon-name" class="pokemon-name"></div>
                    <img id="self-pokemon-img" />
                    <div class="health-bar-container"><div id="self-health-bar" class="health-bar"></div></div>
                    <div id="self-hp-text" class="hp-text"></div>
                    <div id="self-moves" class="moves-container"></div>
                </div>
            </div>
            <div id="opponent-area" class="player-area">
                 <div id="opponent-party-display" class="party-display"></div>
                 <div id="opponent-main-card" class="main-card">
                    <div id="opponent-pokemon-name" class="pokemon-name"></div>
                    <img id="opponent-pokemon-img" />
                    <div class="health-bar-container"><div id="opponent-health-bar" class="health-bar"></div></div>
                    <div id="opponent-hp-text" class="hp-text"></div>
                 </div>
            </div>
        </div>
        <div id="message-log"></div>
    </div>
    
    <div id="map-ui" class="hidden">
        <div id="map-container">
            <canvas id="map-canvas" width="800" height="600"></canvas>
            <div id="map-overlay-text">Use WASD to explore. Find the Shrine to battle again!</div>
            <div id="map-party-display"></div>
        </div>
    </div>

    <div id="modal-overlay" class="hidden">
        <div class="modal-content">
            <h2 id="modal-title"></h2>
            <div id="choices-container"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const socket = io();

            const lobbyUI = document.getElementById('lobby');
            const battleUI = document.getElementById('battle-ui');
            const mapUI = document.getElementById('map-ui');
            const findGameBtn = document.getElementById('find-game-btn');
            const lobbyText = document.getElementById('lobby-text');
            const messageLog = document.getElementById('message-log');
            const modalOverlay = document.getElementById('modal-overlay');
            const modalTitle = document.getElementById('modal-title');
            const choicesContainer = document.getElementById('choices-container');
            const mapCanvas = document.getElementById('map-canvas');
            const mapCtx = mapCanvas.getContext('2d');
            const mapPartyDisplay = document.getElementById('map-party-display');
            const TILE_SIZE = 40;

            let selfId = null;
            let gameState = null;
            let uiState = 'lobby';
            let mapData = { location: null, grid: null };
            let playerParty = [];

            const spriteCanvas = document.createElement('canvas');
            spriteCanvas.width = 8; spriteCanvas.height = 8;
            let seed = 0;
            function seededRandom() { seed = (seed * 9301 + 49297) % 233280; return seed / 233280; }
            function stringToSeed(str) { let h = 1779033703, i, c; for (i = 0; i < str.length; i++) { c = str.charCodeAt(i); h = Math.imul(h ^ c, 2654435761); } return (h ^ h >>> 16) >>> 0; }
            function generatePokemonImage(name) {
                const ctx = spriteCanvas.getContext('2d');
                seed = stringToSeed(name);
                ctx.clearRect(0, 0, 8, 8);
                const mainHue = Math.floor(seededRandom() * 360);
                const mainColor = `hsl(${mainHue}, 70%, 50%)`, shadowColor = `hsl(${mainHue}, 70%, 30%)`;
                for (let y = 0; y < 8; y++) { for (let x = 0; x < 4; x++) { if (seededRandom() > 0.4) { ctx.fillStyle = (y > 4 && seededRandom() > 0.3) ? shadowColor : mainColor; ctx.fillRect(x, y, 1, 1); ctx.fillRect(7 - x, y, 1, 1); } } }
                const eyeY = Math.floor(seededRandom() * 2) + 2;
                ctx.fillStyle = "white"; ctx.fillRect(2, eyeY, 1, 1); ctx.fillRect(5, eyeY, 1, 1);
                return spriteCanvas.toDataURL();
            }

            function switchUI(state) {
                uiState = state;
                [lobbyUI, battleUI, mapUI].forEach(el => el.classList.add('hidden'));
                if (state === 'lobby') lobbyUI.classList.remove('hidden');
                if (state.includes('Battle')) battleUI.classList.remove('hidden');
                if (state === 'map') mapUI.classList.remove('hidden');
            }

            function renderBattleUI() {
                if (!gameState) return;
                const battleType = gameState.players.player2.id === 'wild' ? 'wild' : 'pvp';
                const selfKey = gameState.players.player1.id === selfId ? 'player1' : 'player2';
                const opponentKey = selfKey === 'player1' ? 'player2' : 'player1';
                
                renderPlayerArea('self', gameState.players[selfKey], selfKey === gameState.turn, battleType);
                renderPlayerArea('opponent', gameState.players[opponentKey], false, battleType);
            }

            function renderPlayerArea(prefix, playerData, isMyTurn, battleType) {
                const partyDisplay = document.getElementById(`${prefix}-party-display`);
                partyDisplay.innerHTML = '';
                if (!playerData || !playerData.party) return;
                playerData.party.forEach((mon, index) => {
                    const monDiv = document.createElement('div');
                    monDiv.className = 'party-mon';
                    monDiv.innerHTML = `<img src="${generatePokemonImage(mon.name)}" title="${mon.name}"/>`;
                    if (index === playerData.activePokemonIndex) monDiv.classList.add('active');
                    if (mon.isFainted) monDiv.classList.add('fainted');
                    partyDisplay.appendChild(monDiv);
                });
                if (playerData.party.length === 0) return;
                const activeMon = playerData.party[playerData.activePokemonIndex];
                if (!activeMon) return;
                document.getElementById(`${prefix}-pokemon-name`).textContent = activeMon.name;
                document.getElementById(`${prefix}-pokemon-img`).src = generatePokemonImage(activeMon.name);
                document.getElementById(`${prefix}-health-bar`).style.width = `${(activeMon.currentHp / activeMon.maxHp) * 100}%`;
                document.getElementById(`${prefix}-hp-text`).textContent = `${Math.ceil(activeMon.currentHp)} / ${activeMon.maxHp}`;
                const movesContainer = document.getElementById(`${prefix}-moves`);
                if (prefix === 'self' && movesContainer) {
                    movesContainer.innerHTML = '';
                    if (!activeMon.isFainted) {
                        activeMon.moves.forEach((move, i) => {
                            const btn = document.createElement('button');
                            btn.textContent = move.name;
                            btn.title = `Power: ${move.power} | Type: ${move.type}`;
                            btn.disabled = !isMyTurn || gameState.phase === 'fainted';
                            btn.onclick = () => socket.emit('chooseMove', { moveIndex: i, battleType });
                            movesContainer.appendChild(btn);
                        });
                    }
                }
            }

            const TILE_COLORS = { 0: '#7bb764', 1: '#4a3d2a', 2: '#5b98de', 3: '#4e8538', 4: '#d4af37' };
            function drawMap() {
                if (!mapData.grid) return;
                mapCtx.clearRect(0, 0, mapCanvas.width, mapCanvas.height);
                for (let y = 0; y < mapData.grid.length; y++) { for (let x = 0; x < mapData.grid[0].length; x++) { mapCtx.fillStyle = TILE_COLORS[mapData.grid[y][x]]; mapCtx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE); } }
                mapCtx.fillStyle = '#ff0000';
                mapCtx.fillRect(mapData.location.x * TILE_SIZE + 10, mapData.location.y * TILE_SIZE + 10, TILE_SIZE - 20, TILE_SIZE - 20);
            }

            function renderMapParty() {
                mapPartyDisplay.innerHTML = '';
                playerParty.forEach(mon => {
                    const monDiv = document.createElement('div');
                    monDiv.className = 'party-mon';
                    monDiv.innerHTML = `<img src="${generatePokemonImage(mon.name)}" title="${mon.name} - HP: ${Math.ceil(mon.currentHp)}/${mon.maxHp}"/>`;
                    if(mon.isFainted) monDiv.classList.add('fainted');
                    mapPartyDisplay.appendChild(monDiv);
                });
            }

            function showChoiceModal(title, choices, type) {
                modalOverlay.classList.remove('hidden');
                modalTitle.textContent = title;
                choicesContainer.innerHTML = '';
                choices.forEach((choice) => {
                    const card = document.createElement('div');
                    card.className = 'choice-card';
                    card.innerHTML = `<img src="${generatePokemonImage(choice.name)}" style="width:96px; height:96px;" /><h3>${choice.name}</h3><p>HP: ${Math.ceil(choice.currentHp)}/${choice.maxHp}</p>`;
                    card.onclick = () => {
                        if (type === 'forceSwitch') {
                            const selfKey = gameState.players.player1.id === selfId ? 'player1' : 'player2';
                            const originalIndex = gameState.players[selfKey].party.findIndex(p => p.name === choice.name && !p.isFainted);
                            if (originalIndex !== -1) socket.emit('switchPokemon', { pokemonIndex: originalIndex });
                        } else {
                            socket.emit('makeChoice', { choice, type });
                        }
                        modalOverlay.classList.add('hidden');
                    };
                    choicesContainer.appendChild(card);
                });
            }

            socket.on('connect', () => { selfId = socket.id; });
            socket.on('waiting', () => { lobbyText.textContent = "Waiting for an opponent..."; });
            socket.on('gameStart', () => { switchUI('pvpBattle'); });
            socket.on('updateGameState', (newGameState) => { gameState = newGameState; renderBattleUI(); });
            socket.on('logMessage', (msg) => { messageLog.innerHTML = msg; });
            socket.on('promptChoice', ({ title, choices, type }) => showChoiceModal(title, choices, type));
            socket.on('endGame', (result) => {
                if (result === 'win') {
                    lobbyText.textContent = "You are victorious! Waiting for a new challenger...";
                    findGameBtn.disabled = false;
                    switchUI('lobby');
                }
            });
            socket.on('enterMapMode', ({ location, mapGrid, party }) => {
                mapData = { location, grid: mapGrid };
                playerParty = party;
                switchUI('map');
                renderMapParty();
                drawMap();
            });
            socket.on('updateMap', ({ location, mapGrid }) => { mapData = { location, grid: mapGrid }; drawMap(); });
            socket.on('startWildBattle', ({ wildPokemon, playerParty: serverParty }) => {
                playerParty = serverParty;
                gameState = { phase: 'wildBattle', players: { player1: { id: selfId, party: playerParty, activePokemonIndex: 0 }, player2: { id: 'wild', party: [wildPokemon], activePokemonIndex: 0 } }, turn: 'player1' };
                switchUI('wildBattle');
                renderBattleUI();
                messageLog.innerHTML = `A wild ${wildPokemon.name} appeared!`;
            });
            socket.on('wildBattleUpdate', ({ playerPokemon, wildPokemon }) => {
                gameState.players.player1.party[gameState.players.player1.activePokemonIndex] = playerPokemon;
                gameState.players.player2.party[0] = wildPokemon;
                renderBattleUI();
            });
            socket.on('returnToLobby', () => { alert("You step on the shrine and are ready to challenge again!"); window.location.reload(); });
            socket.on('opponentDisconnected', () => { alert("Opponent disconnected."); window.location.reload(); });
            
            findGameBtn.addEventListener('click', () => {
                socket.emit('findGame');
                lobbyText.textContent = "Searching for opponent...";
                findGameBtn.disabled = true;
            });
            
            window.addEventListener('keydown', (e) => {
                if (uiState !== 'map') return;
                const key = e.key.toLowerCase();
                if (['w', 'a', 's', 'd'].includes(key)) { socket.emit('move', { direction: key }); }
            });
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Pok√©-Roguelike World</title>
    <style>
        /* ... All previous CSS ... */
        /* New CSS for Mobile Controls and Party Screen */
        #mobile-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 150px;
            height: 150px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            gap: 5px;
            opacity: 0.5;
            z-index: 100;
        }
        .control-pad {
            background-color: rgba(0,0,0,0.5);
            border: 2px solid white;
            border-radius: 10px;
        }
        @media (min-width: 800px) {
            #mobile-controls { display: none; } /* Hide on desktop */
        }
        /* Party Modal CSS */
        .party-member-card {
            display: flex;
            align-items: center;
            border: 2px solid #333;
            padding: 10px;
        }
        .party-member-card img { width: 48px; height: 48px; }
        .party-member-stats { margin-left: 15px; font-size: 10px; text-align: left; }
    </style>
</head>
<body>
    <!-- ... Battle UI and Hub UI HTML is the same ... -->
    <div id="hub-ui" class="hidden">
        <div id="hub-container">
            <!-- ... canvas and overlays ... -->
        </div>
        <div id="mobile-controls">
            <!-- This will be populated by JS -->
        </div>
    </div>
    <!-- ... Modals ... -->

    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ... all DOM element lookups and state variables ...
            const mobileControls = document.getElementById('mobile-controls');

            function initializeMobileControls() {
                const directions = [
                    { dx: -1, dy: -1 }, { dx: 0, dy: -1 }, { dx: 1, dy: -1 },
                    { dx: -1, dy: 0 },  { dx: 0, dy: 0 },  { dx: 1, dy: 0 },
                    { dx: -1, dy: 1 },  { dx: 0, dy: 1 },  { dx: 1, dy: 1 }
                ];
                mobileControls.innerHTML = '';
                directions.forEach(dir => {
                    const pad = document.createElement('div');
                    pad.className = 'control-pad';
                    if (dir.dx === 0 && dir.dy === 0) {
                        pad.textContent = 'E'; // Interact button
                        pad.style.fontSize = '24px';
                        pad.style.color = 'white';
                        pad.style.textAlign = 'center';
                        pad.style.lineHeight = '40px';
                        pad.onclick = () => socket.emit('interact');
                    } else {
                        pad.onclick = () => socket.emit('move', dir);
                    }
                    mobileControls.appendChild(pad);
                });
            }

            const TILE_COLORS = { 0: '#7bb764', 1: '#4a3d2a', 2: '#5b98de', 3: '#4e8538', 4: 'var(--shrine-color)', 5: 'var(--mart-color)', 6: 'var(--center-color)', 7: '#ff8800' }; // Added NPC color
            function drawMap() {
                if (!mapData.grid) return;
                mapCtx.clearRect(0, 0, mapCanvas.width, mapCanvas.height);
                // Draw grid
                for (let y = 0; y < mapData.grid.length; y++) { for (let x = 0; x < mapData.grid[0].length; x++) { mapCtx.fillStyle = TILE_COLORS[mapData.grid[y][x]]; mapCtx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE); } }
                
                // Draw NPCs
                if (mapData.npcs) {
                    mapData.npcs.forEach(npc => {
                        mapCtx.fillStyle = TILE_COLORS[7]; // NPC color
                        mapCtx.fillRect(npc.x * TILE_SIZE + 5, npc.y * TILE_SIZE + 5, TILE_SIZE - 10, TILE_SIZE - 10);
                    });
                }

                // Draw Player
                if (mapData.location) { mapCtx.fillStyle = '#ff0000'; mapCtx.fillRect(mapData.location.x * TILE_SIZE + 10, mapData.location.y * TILE_SIZE + 10, TILE_SIZE - 20, TILE_SIZE - 20); }
            }

            function showPartyModal() {
                modalOverlay.classList.remove('hidden');
                modalTitle.textContent = "Your Party";
                choicesContainer.innerHTML = '';
                playerState.party.forEach(mon => {
                    const card = document.createElement('div');
                    card.className = 'party-member-card';
                    card.innerHTML = `
                        <img src="${generatePokemonImage(mon.name)}" />
                        <div class="party-member-stats">
                            <h3>${mon.name}</h3>
                            <p>HP: ${Math.ceil(mon.currentHp)} / ${mon.maxHp}</p>
                            <p>ATK: ${mon.attack} | DEF: ${mon.defense}</p>
                            <p>Type: ${mon.type}</p>
                        </div>
                    `;
                    choicesContainer.appendChild(card);
                });
            }

            // --- SOCKET LISTENERS ---
            socket.on('enterHubMode', (data) => {
                playerState = data.playerState;
                mapData = data.mapData; // Contains both .grid and .npcs
                switchUI('hub');
                renderHubUI();
                drawMap();
                initializeMobileControls();
            });
            // ... other listeners ...
            socket.on('updateMap', (data) => {
                mapData = data.mapData;
                playerState.location = data.location;
                drawMap();
            });

            // --- INPUT LISTENERS ---
            window.addEventListener('keydown', (e) => {
                if (uiState !== 'hub') return;
                const key = e.key.toLowerCase();
                
                if (key === 'p') {
                    showPartyModal();
                    return;
                }

                if (['e', 'enter'].includes(key)) {
                    socket.emit('interact');
                }
                
                const moveDir = {dx: 0, dy: 0};
                if (key === 'w') moveDir.dy = -1;
                if (key === 'a') moveDir.dx = -1;
                if (key === 's') moveDir.dy = 1;
                if (key === 'd') moveDir.dx = 1;

                if (moveDir.dx !== 0 || moveDir.dy !== 0) {
                    socket.emit('move', moveDir);
                }
            });
            
            // ... other listeners like shopBtn, challengeBtn ...
        });
    </script>
</body>
</html>

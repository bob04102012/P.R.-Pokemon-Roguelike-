<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poké-Roguelike World</title>
    <style>
        /* CSS is identical to the previous version. No changes needed. */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        :root{--main-font:'Press Start 2P',cursive;--border-color:#333;--background-color:#f0f0f0;--player1-color:#4a90e2;--player2-color:#e24a4a;--grass-type:#78C850;--fire-type:#F08030;--water-type:#6890F0;--electric-type:#F8D030;--rock-type:#B8A038;--ghost-type:#705898;--normal-type:#A8A878; --shrine-color: #d4af37; --mart-color: #4a90e2; --center-color: #e24a4a;}
        body{font-family:var(--main-font);background-color:var(--background-color);color:#333;text-align:center;padding:10px;font-size:12px;overflow:hidden;}
        .hidden{display:none!important}#battle-ui, #hub-ui { width: 100%; max-width: 900px; margin: auto; }
        .arena{display:flex;justify-content:space-around;gap:20px;margin-bottom:15px}.player-area{width:48%}.party-display{display:flex;gap:5px;margin-bottom:10px;justify-content:center;height:40px}
        .party-mon{border:2px solid #ccc;padding:5px;font-size:10px;opacity:0.6;cursor:pointer;position:relative}
        .party-mon img { width: 32px; height: 32px; image-rendering: pixelated; display: block; margin: 0 auto 4px auto; }
        .party-mon.active{border-color:gold;opacity:1;transform:scale(1.1)}.party-mon.fainted{background-color:#555;color:#999;text-decoration:line-through}
        .main-card{border:4px solid var(--border-color);padding:15px;background:white}.main-card img {width:96px; height:96px; image-rendering:pixelated; margin: 10px auto; display: block; border: 2px solid #333; background: #eee;}
        .pokemon-name{font-size:16px;margin-bottom:10px;min-height:20px;}.health-bar-container{width:100%;height:18px;background-color:#e0e0e0;border:2px solid var(--border-color);margin-bottom:5px}.health-bar{height:100%;background-color:#4CAF50;width:100%;transition:width .5s ease-in-out}.hp-text{font-size:10px;text-align:right;margin-bottom:10px}
        .moves-container button { width: calc(50% - 4px); padding: 8px; margin: 2px; font-family: var(--main-font); font-size: 10px; cursor: pointer; border: 2px solid var(--border-color); }
        #message-log{padding:15px;background:white;border:4px solid var(--border-color);min-height:60px;text-align:left;line-height:1.5;margin-top:10px}
        #hub-container { position: relative; width: 800px; height: 600px; margin: auto; border: 4px solid #333; }
        #map-canvas { background-color: #5a8d3c; image-rendering: pixelated; width: 100%; height: 100%; }
        .hub-overlay { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: white; padding: 10px; font-size: 14px; display: flex; justify-content: space-between; align-items: center; width: calc(100% - 40px); }
        .hub-overlay button { font-family: var(--main-font); font-size: 12px; margin-left: 20px; cursor: pointer;}
        #hub-party-display { position: absolute; bottom: 10px; left: 10px; display: flex; gap: 5px; background: rgba(0,0,0,0.6); padding: 5px; border-radius: 5px; }
        #modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:99;display:flex;justify-content:center;align-items:center}.modal-content{background:white;padding:30px;border:4px solid var(--border-color);max-width:80%;width:700px;max-height:80vh;overflow-y:auto;}
        #modal-title{font-size:20px;margin-bottom:20px}#choices-container{display:flex;flex-direction:column;gap:15px;}
        .choice-card{border:3px solid var(--border-color);padding:15px;cursor:pointer;transition:all .2s ease;display:flex;justify-content:space-between;align-items:center;}.choice-card:hover{background-color:#eee}
        .choice-card.disabled { background-color: #d3d3d3; color: #888; cursor: not-allowed; } /* Renamed from "purchased" */
        .upgrade-info p { margin: 0; font-size: 10px; line-height: 1.4; }
        .upgrade-level { font-size: 10px; color: #555; }
    </style>
</head>
<body>
    <!-- HTML is identical to previous version -->
    <div id="battle-ui" class="hidden">...</div>
    <div id="hub-ui" class="hidden">...</div>
    <div id="modal-overlay" class="hidden">...</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements, State Variables, Image Generation (Identical) ---
            const socket = io();
            const battleUI = document.getElementById('battle-ui');
            const hubUI = document.getElementById('hub-ui');
            // ... all other element lookups ...
            let selfId = null, gameState = null, uiState = 'hub', mapData = { location: null, grid: null }, playerState = null;
            function generatePokemonImage(name) { /* ... */ }
            function switchUI(state) { /* ... */ }
            function drawMap() { /* ... */ }
            function renderHubUI() { /* ... */ }
            function renderBattleUI() { /* ... */ }
            function renderPlayerArea(prefix, playerData, isMyTurn) { /* ... */ }
            function showChoiceModal(title, choices, type) { /* ... */ }

            // *** SHOP MODAL REWORKED ***
            function showShopModal(shopData) {
                modalOverlay.classList.remove('hidden');
                modalTitle.textContent = "Poké Mart - Permanent Upgrades";
                choicesContainer.innerHTML = '';
                for (const id in shopData.upgrades) {
                    const upgrade = shopData.upgrades[id];
                    const currentLevel = playerState.upgrades.levels[id] || 0;
                    const isOneTime = id === 'scouting';
                    
                    const card = document.createElement('div');
                    card.className = 'choice-card';

                    let cost, effectText, levelText;
                    if (isOneTime) {
                        cost = upgrade.baseCost;
                        effectText = upgrade.description;
                        levelText = currentLevel > 0 ? '(Purchased)' : '';
                    } else {
                        cost = Math.floor(upgrade.baseCost * Math.pow(1.5, currentLevel));
                        effectText = upgrade.description.replace('+10', `+${10 * (currentLevel + 1)}`).replace('+5', `+${5 * (currentLevel + 1)}`);
                        levelText = `(Level ${currentLevel})`;
                    }

                    card.innerHTML = `
                        <div class="upgrade-info">
                            <h3>${upgrade.name} <span class="upgrade-level">${levelText}</span></h3>
                            <p>${effectText}</p>
                        </div>
                        <div class="upgrade-cost">$P ${cost}</div>`;
                    
                    if ((isOneTime && currentLevel > 0) || playerState.currency < cost) {
                        card.classList.add('disabled');
                    } else {
                        card.onclick = () => { socket.emit('buyUpgrade', id); modalOverlay.classList.add('hidden'); };
                    }
                    choicesContainer.appendChild(card);
                }
                const closeBtn = document.createElement('button');
                closeBtn.textContent = 'Close';
                closeBtn.style.marginTop = '20px';
                closeBtn.onclick = () => modalOverlay.classList.add('hidden');
                choicesContainer.appendChild(closeBtn);
            }

            // --- Socket Listeners (Identical, with one change) ---
            socket.on('connect', () => { selfId = socket.id; });
            socket.on('enterHubMode', (data) => {
                playerState = data.playerState;
                mapData = { location: data.location, grid: data.mapGrid };
                switchUI('hub');
                renderHubUI();
                drawMap();
                challengeBtn.disabled = false;
                challengeBtn.textContent = 'Find Battle';
            });
            // ... all other listeners ...
            socket.on('shopData', (data) => {
                showShopModal(data); // This is now correctly called
            });
            
            // --- Input Listeners (Identical) ---
            challengeBtn.addEventListener('click', () => socket.emit('enterChallengeQueue'));
            shopBtn.addEventListener('click', () => {
                // Now we ask the server for the latest shop data before showing
                socket.emit('getShopData');
            });
            modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) modalOverlay.classList.add('hidden'); });
            window.addEventListener('keydown', (e) => { /* ... */ });
        });
    </script>
</body>
</html>
